name: Documentation Preview

on:
  pull_request:
    branches: [ main, develop ]
    paths:
      - 'docs/**'
      - 'mkdocs.yml'
      - '.github/workflows/docs.yml'

permissions:
  contents: read
  pull-requests: write

jobs:
  preview:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.11'

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install mkdocs-material
          pip install mkdocs-git-revision-date-localized-plugin
          pip install mkdocs-minify-plugin

      - name: Build documentation
        run: mkdocs build

      - name: Comment PR
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            const path = require('path');

            // Get the size of the built site
            const sitePath = './site';
            const getSize = (dir) => {
              let size = 0;
              const files = fs.readdirSync(dir);
              for (const file of files) {
                const filePath = path.join(dir, file);
                const stat = fs.statSync(filePath);
                if (stat.isDirectory()) {
                  size += getSize(filePath);
                } else {
                  size += stat.size;
                }
              }
              return size;
            };

            const siteSize = getSize(sitePath);
            const sizeInMB = (siteSize / (1024 * 1024)).toFixed(2);

            // Create comment
            const comment = `## ðŸ“š Documentation Preview

            The documentation has been successfully built!

            **Build Stats:**
            - Site size: ${sizeInMB} MB
            - Pages: ${fs.readdirSync(sitePath).length} files

            **Next Steps:**
            - Review the documentation changes
            - Check for any broken links or formatting issues
            - Ensure all new features are properly documented

            **Preview:** The documentation will be available at the GitHub Pages URL once this PR is merged.`;

            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: comment
            });

      - name: Upload build artifacts
        uses: actions/upload-artifact@v4
        with:
          name: documentation-build
          path: ./site
          retention-days: 7
